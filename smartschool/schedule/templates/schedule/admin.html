{% extends 'base.html' %}

{% block title %}–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å - SmartSchool{% endblock %}
{% block page_title %}AI –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block content %}
<div class="animate-fade-in max-w-4xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-slate-900 tracking-tight">AI –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p class="text-slate-500 mt-1">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —à–∫–æ–ª–æ–π —Å –ø–æ–º–æ—â—å—é –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 h-[calc(100vh-200px)] flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white">
                    ‚ö°
                </div>
                <div>
                    <h3 class="font-bold text-slate-800">AI Admin</h3>
                    <p class="text-xs text-green-500">üü¢ –í —Å–µ—Ç–∏</p>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
            <div class="flex justify-start">
                <div class="max-w-[85%] px-4 py-3 rounded-2xl shadow-sm bg-white border border-slate-200 text-slate-800 rounded-tl-none">
                    <p class="text-sm">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é. –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å: "–î–æ–±–∞–≤—å —É—Ä–æ–∫ —Ñ–∏–∑–∏–∫–∏ –¥–ª—è 10–ê –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 3-–π —É—Ä–æ–∫ –≤ –∫–∞–±–∏–Ω–µ—Ç 202"</p>
                </div>
            </div>
        </div>

        <!-- Input -->
        <form id="chat-form" class="p-4 border-t border-slate-200 bg-white">
            <div class="relative">
                <input 
                    type="text" 
                    id="command-input"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è..."
                    class="w-full bg-slate-100 border-none rounded-xl px-4 py-4 pr-12 focus:ring-2 focus:ring-indigo-500 text-sm"
                />
                <button 
                    type="submit"
                    id="send-btn"
                    class="absolute right-2 top-2 w-10 h-10 flex items-center justify-center bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed"
                >
                    ‚û§
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('command-input');
    const sendBtn = document.getElementById('send-btn');
    const command = input.value.trim();
    
    if (!command) return;
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
    sendBtn.disabled = true;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(command, 'user');
    input.value = '';
    
    try {
        const response = await fetch('/api/ai-command/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command })
        });
        
        if (!response.ok) throw new Error('Server error');
        
        const data = await response.json();
        addMessage(data.explanation, 'assistant');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        showNotification('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        
    } catch (error) {
        addMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'assistant');
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã', 'error');
    } finally {
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
        sendBtn.disabled = false;
        input.focus();
    }
});

function addMessage(content, role) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
    
    const bgClass = role === 'user' 
        ? 'bg-indigo-600 text-white rounded-tr-none' 
        : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none';
    
    messageDiv.innerHTML = `
        <div class="max-w-[85%] px-4 py-3 rounded-2xl shadow-sm ${bgClass}">
            <p class="text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
            <div class="text-[10px] mt-1 ${role === 'user' ? 'text-indigo-200 text-right' : 'text-slate-400'}">
                ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
            </div>
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showNotification(message, type) {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    console.log(`[${type.toUpperCase()}] ${message}`);
}
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fadeIn 0.4s ease-out forwards;
}
</style>
{% endblock %}